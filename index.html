<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Condolist (iOS 26)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts: Prompt & SF Style -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Prompt', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    colors: {
                        ios: {
                            blue: '#007AFF',
                            glass: 'rgba(255, 255, 255, 0.65)',
                            glassDark: 'rgba(0, 0, 0, 0.5)',
                            surface: 'rgba(255, 255, 255, 0.4)',
                        }
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Reset */
        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: #F2F2F7;
            color: #1c1c1e;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* --- LIQUID BACKGROUND --- */
        .liquid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: #F2F2F7;
            overflow: hidden;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: blob 10s infinite cubic-bezier(0.4, 0, 0.2, 1);
        }
        .orb-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #FF9A9E; animation-delay: 0s; }
        .orb-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #a18cd1; animation-delay: 2s; }
        .orb-3 { top: 40%; left: 30%; width: 40vw; height: 40vw; background: #fbc2eb; animation-delay: 4s; }

        /* --- GLASSMORPHISM --- */
        .ultra-glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .glass-card:active { transform: scale(0.98); }

        /* --- UI ELEMENTS --- */
        .story-ring {
            background: linear-gradient(135deg, #FF3CAC 0%, #784BA0 50%, #2B86C5 100%);
            padding: 3px;
            border-radius: 50%;
        }
        
        /* New Filter Active Ring */
        .filter-ring-active {
            background: linear-gradient(135deg, #007AFF, #00C6FF); /* iOS Blue Gradient */
            box-shadow: 0 0 15px rgba(0, 122, 255, 0.4);
        }
        
        .ios-btn {
            background: linear-gradient(135deg, #007AFF, #00C6FF);
            color: white;
            border-radius: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 20px -5px rgba(0, 122, 255, 0.4);
            transition: all 0.3s ease;
        }
        .ios-btn:active { transform: scale(0.95); opacity: 0.9; }

        /* LINE BUTTON STYLE */
        .line-btn {
            background: linear-gradient(135deg, #06C755, #00B900); /* Line Brand Color */
            color: white;
            border-radius: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 20px -5px rgba(6, 199, 85, 0.4);
            transition: all 0.3s ease;
        }
        .line-btn:active { transform: scale(0.95); opacity: 0.9; }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Grid */
        .grid-square { position: relative; width: 100%; padding-bottom: 100%; overflow: hidden; border-radius: 4px; }
        .grid-square img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }

        /* Modal Animation */
        .modal-enter { animation: springUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes springUp {
            from { transform: translateY(100%) scale(0.8); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* Loading */
        #loadingOverlay {
            background: rgba(255,255,255,0.3);
            backdrop-filter: blur(20px);
            z-index: 9999;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #007AFF 0%, #AF52DE 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* CHAT WIDGET STYLES */
        .chat-float-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #007AFF, #00C6FF);
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0, 122, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 28px;
            cursor: pointer;
            z-index: 999;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden; 
        }
        .chat-float-btn:hover { transform: scale(1.1); }
        .chat-float-btn img { width: 100%; height: 100%; object-fit: cover; }
        
        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 350px;
            max-width: calc(100vw - 48px);
            height: 500px;
            max-height: 80vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 998;
            transform-origin: bottom right;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chat-window.hidden {
            opacity: 0;
            transform: scale(0.8) translateY(20px);
            pointer-events: none;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #007AFF, #00C6FF);
            padding: 16px;
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header .bot-info { display: flex; align-items: center; gap: 10px; }
        .chat-header img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.5); }
        
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            font-size: 14px;
        }
        
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .message.user {
            align-self: flex-end;
            background: #007AFF;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.ai {
            align-self: flex-start;
            background: #f1f1f1;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #aaa;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid rgba(0,0,0,0.05);
            background: rgba(255,255,255,0.8);
            display: flex;
            gap: 8px;
        }
        .chat-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .chat-input:focus { border-color: #007AFF; }
    </style>
</head>
<body class="pb-24 md:pb-0 text-gray-800">

    <!-- LIQUID BACKGROUND BLOBS -->
    <div class="liquid-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <!-- CONFIG -->
    <script>
        // *** REPLACE THIS WITH YOUR GOOGLE APPS SCRIPT WEB APP URL ***
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxec2WVPdaQP_i3zdij5ZBBctghL7NJC2kDcs1gVF3nEpsc6-2PfHyyf9dw-Mw8u56l3w/exec";
        
        // *** GEMINI API KEY ***
        const apiKey = "AIzaSyD5BAKXcUIS-kzAF56miiimF5nsmsXnlyU"; // Connected!
        
        // --- MOCK DATA FOR DEMO ---
        const MOCK_SETTINGS = {
            profileName: "Condo Agent Pro",
            profileDesc: "Luxury Living Redefined. BTS/MRT Expert.",
            profileImage: "https://img.freepik.com/free-photo/portrait-handsome-young-man-with-crossed-arms_176420-15569.jpg?w=300",
            lineUrl: "https://line.me/ti/p/~example", 
            mapUrl: "https://maps.google.com"
        };

        const MOCK_PROPERTIES = [
            {
                id: "1", type: "Studio", status: "Post", unit: "1204", floor: "12", size: "28", price: "12,000", saleType: "Rent",
                description: "‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î Studio ‡πÅ‡∏ï‡πà‡∏á‡∏Ñ‡∏£‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏¢‡∏π‡πà ‡∏ä‡∏±‡πâ‡∏ô 12 ‡∏ß‡∏¥‡∏ß‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° ‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏ö‡∏Ñ‡∏£‡∏±‡∏ô ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á",
                images: JSON.stringify(["https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?w=500", "https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?w=500"]),
                contractOwner: JSON.stringify(["https://example.com/contract1.pdf"]), 
                timestamp: new Date().toISOString()
            },
            {
                id: "8", type: "2BED", status: "Post", unit: "999", floor: "20", size: "60", price: "25,000 / 5.5M", saleType: "Both",
                description: "‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏©! ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î 2 ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô ‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á ‡∏ß‡∏¥‡∏ß‡πÇ‡∏•‡πà‡∏á ‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡∏á 60 ‡∏ï‡∏£.‡∏°. ‡∏à‡∏∞‡πÄ‡∏ä‡πà‡∏≤‡∏Å‡πá‡∏Ñ‡∏∏‡πâ‡∏° ‡∏à‡∏∞‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡πá‡∏î‡∏µ ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏´‡∏£‡∏π‡∏´‡∏£‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
                images: JSON.stringify(["https://images.unsplash.com/photo-1560185007-cde436f6a4d0?w=500", "https://images.unsplash.com/photo-1484154218962-a1c002085d2f?w=500"]),
                timestamp: new Date().toISOString()
            },
            {
                id: "2", type: "1BED", status: "Post", unit: "0809", floor: "8", size: "35", price: "3.5M", saleType: "Sell",
                images: JSON.stringify(["https://images.unsplash.com/photo-1502005229762-cf1b2da7c5d6?w=500", "https://images.unsplash.com/photo-1484154218962-a1c002085d2f?w=500"]),
                timestamp: new Date().toISOString()
            },
            {
                id: "3", type: "2BED", status: "Post", unit: "2501", floor: "25", size: "65", price: "28,000", saleType: "Rent",
                images: JSON.stringify(["https://images.unsplash.com/photo-1560448204-e02f11c3d0e2?w=500"]),
                timestamp: new Date().toISOString()
            },
            {
                id: "4", type: "Facility", status: "Post", unit: "Pool", floor: "Rooftop", size: "-", price: "Free", saleType: "Rent",
                images: JSON.stringify(["https://images.unsplash.com/photo-1576013551627-0cc20b96c2a7?w=500"]),
                timestamp: new Date().toISOString()
            },
            {
                id: "5", type: "1BED", status: "Rented", unit: "1010", floor: "10", size: "34", price: "15,000", saleType: "Rent",
                images: JSON.stringify(["https://images.unsplash.com/photo-1493663284031-b7e3aefcae8e?w=500"]),
                contractOwner: JSON.stringify(["https://example.com/owner_doc.pdf"]),
                contractTenant: JSON.stringify(["https://example.com/contract_year1.pdf", "https://example.com/contract_year2.pdf"]),
                rentedStart: "2023-01-01", rentedEnd: "2023-12-31",
                timestamp: new Date().toISOString()
            },
            {
                id: "6", type: "Studio", status: "Draft", unit: "Pending", floor: "-", size: "-", price: "Wait", saleType: "Sell",
                images: JSON.stringify(["https://via.placeholder.com/500?text=Draft+Room"]),
                timestamp: new Date().toISOString()
            },
            {
                id: "7", type: "1BED", status: "Post", unit: "1515", floor: "15", size: "40", price: "18,000", saleType: "Rent",
                images: JSON.stringify(["https://images.unsplash.com/photo-1554995207-c18c203602cb?w=500"]),
                timestamp: new Date().toISOString()
            }
        ];
    </script>

    <!-- LOADING -->
    <div id="loadingOverlay" class="fixed inset-0 flex flex-col items-center justify-center hidden">
        <div class="relative w-20 h-20">
            <div class="absolute inset-0 rounded-full border-4 border-blue-100"></div>
            <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app" class="max-w-4xl mx-auto min-h-screen relative z-10">

        <!-- FLOATING HEADER -->
        <header class="fixed top-4 left-4 right-4 z-50 ultra-glass rounded-full px-6 py-3 flex justify-between items-center max-w-4xl mx-auto transition-all duration-300">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600 cursor-pointer" onclick="app.goHome()">Condolist</h1>
            <div class="relative">
                <button onclick="app.toggleMenu()" class="w-10 h-10 rounded-full bg-white/50 hover:bg-white flex items-center justify-center transition shadow-sm">
                    <i class="fas fa-bars text-gray-600"></i>
                </button>
                
                <!-- Floating Menu -->
                <div id="navDropdown" class="hidden absolute right-0 mt-4 w-60 ultra-glass rounded-3xl p-2 z-50 transform origin-top-right transition-all scale-100 shadow-2xl ring-1 ring-white/50">
                    <div id="publicMenu">
                        <a href="#" onclick="app.showLogin()" class="flex items-center px-4 py-3 text-gray-700 hover:bg-white/60 rounded-2xl transition">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 text-blue-600"><i class="fas fa-fingerprint"></i></div>
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
                        </a>
                    </div>
                    <div id="adminMenu" class="hidden space-y-1">
                        <a href="#" onclick="app.showAddRoom()" class="flex items-center px-4 py-3 text-gray-700 hover:bg-white/60 rounded-2xl transition">
                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center mr-3 text-green-600"><i class="fas fa-plus"></i></div> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á
                        </a>
                        <a href="#" onclick="app.showAISettings()" class="flex items-center px-4 py-3 text-gray-700 hover:bg-white/60 rounded-2xl transition">
                            <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mr-3 text-indigo-600"><i class="fas fa-robot"></i></div> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ AI
                        </a>
                        <a href="#" onclick="app.showSettings()" class="flex items-center px-4 py-3 text-gray-700 hover:bg-white/60 rounded-2xl transition">
                            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center mr-3 text-gray-600"><i class="fas fa-sliders-h"></i></div> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
                        </a>
                        <a href="#" onclick="app.toggleAdminView(false)" class="flex items-center px-4 py-3 text-gray-700 hover:bg-white/60 rounded-2xl transition">
                            <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3 text-blue-600"><i class="fas fa-mobile-alt"></i></div> ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                        </a>
                        <a href="#" onclick="app.toggleAdminView(true)" class="flex items-center px-4 py-3 text-gray-700 hover:bg-white/60 rounded-2xl transition">
                            <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center mr-3 text-purple-600"><i class="fas fa-th-large"></i></div> ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
                        </a>
                        <div class="h-px bg-gray-200/50 mx-4 my-1"></div>
                        <a href="#" onclick="app.logout()" class="flex items-center px-4 py-3 text-red-500 hover:bg-red-50/60 rounded-2xl transition">
                            <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center mr-3 text-red-500"><i class="fas fa-power-off"></i></div> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Spacer for Fixed Header -->
        <div class="h-24"></div>

        <!-- 1. PUBLIC VIEW -->
        <div id="publicView" class="px-4">
             <!-- Profile Card -->
             <div class="glass-card p-6 flex items-center gap-6 mb-6">
                <div class="story-ring p-[3px] shadow-xl shrink-0">
                    <img id="profileImg" src="https://via.placeholder.com/150" class="w-20 h-20 rounded-full border-4 border-white object-cover">
                </div>
                <div class="flex-1 min-w-0">
                    <h2 id="profileName" class="text-2xl font-bold mb-1 text-gray-900 truncate">Loading...</h2>
                    <p id="profileDesc" class="text-sm text-gray-600 mb-4 font-light truncate">Loading...</p>
                    <div class="flex gap-3">
                        <a id="btnLine" href="#" target="_blank" class="flex-1 line-btn py-2.5 px-4 text-center text-sm shadow-lg">
                            <i class="fab fa-line mr-2"></i> Line
                        </a>
                        <a id="btnMap" href="#" target="_blank" class="flex-1 bg-white/70 backdrop-blur border border-white text-gray-700 py-2.5 px-4 rounded-[18px] text-center text-sm font-semibold shadow-sm hover:bg-white transition">
                            <i class="fas fa-map-marked-alt mr-2 text-pink-500"></i> Map
                        </a>
                    </div>
                </div>
            </div>

            <!-- Filter Stories -->
            <div class="mb-6 overflow-x-auto hide-scrollbar">
                <div class="flex space-x-6 px-2 min-w-max">
                     <div onclick="app.filter('All')" class="filter-item cursor-pointer flex flex-col items-center gap-2 group" data-type="All">
                        <div class="ring-wrapper p-[2px] rounded-full transition-all duration-300 filter-ring-active">
                            <div class="w-16 h-16 rounded-full glass-card flex items-center justify-center text-xs font-bold text-gray-700 transition shadow-sm bg-white/50">ALL</div>
                        </div>
                        <span class="text-xs font-bold text-blue-600 transition">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </div>
                     <div onclick="app.filter('Studio')" class="filter-item cursor-pointer flex flex-col items-center gap-2 group" data-type="Studio">
                        <div class="ring-wrapper p-[2px] rounded-full transition-all duration-300">
                            <div class="w-16 h-16 rounded-full glass-card flex items-center justify-center text-xs font-medium text-gray-500 transition shadow-sm bg-white/50">Studio</div>
                        </div>
                        <span class="text-xs font-medium text-gray-500 transition">Studio</span>
                    </div>
                    <div onclick="app.filter('1BED')" class="filter-item cursor-pointer flex flex-col items-center gap-2 group" data-type="1BED">
                        <div class="ring-wrapper p-[2px] rounded-full transition-all duration-300">
                            <div class="w-16 h-16 rounded-full glass-card flex items-center justify-center text-xs font-medium text-gray-500 transition shadow-sm bg-white/50">1 Bed</div>
                        </div>
                        <span class="text-xs font-medium text-gray-500 transition">1 Bed</span>
                    </div>
                    <div onclick="app.filter('2BED')" class="filter-item cursor-pointer flex flex-col items-center gap-2 group" data-type="2BED">
                        <div class="ring-wrapper p-[2px] rounded-full transition-all duration-300">
                            <div class="w-16 h-16 rounded-full glass-card flex items-center justify-center text-xs font-medium text-gray-500 transition shadow-sm bg-white/50">2 Bed</div>
                        </div>
                        <span class="text-xs font-medium text-gray-500 transition">2 Bed</span>
                    </div>
                     <div onclick="app.filter('Facility')" class="filter-item cursor-pointer flex flex-col items-center gap-2 group" data-type="Facility">
                        <div class="ring-wrapper p-[2px] rounded-full transition-all duration-300">
                            <div class="w-16 h-16 rounded-full glass-card flex items-center justify-center text-lg text-gray-500 transition shadow-sm bg-white/50"><i class="fas fa-swimming-pool"></i></div>
                        </div>
                        <span class="text-xs font-medium text-gray-500 transition">Facility</span>
                    </div>
                </div>
            </div>

            <!-- Grid Gallery -->
            <div id="propertyGrid" class="grid grid-cols-3 gap-1 md:gap-4 pb-24"></div>
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-400">
                <i class="far fa-folder-open text-4xl mb-4 opacity-50"></i>
                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            </div>
        </div>

        <!-- 2. ADMIN DASHBOARD -->
        <div id="adminDashboard" class="hidden px-4 pb-20">
             <div class="glass-card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h2>
                <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                     <button onclick="app.filterAdmin('All')" class="px-5 py-2 bg-white/50 rounded-full text-sm font-semibold border border-white/50 backdrop-blur shadow-sm">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                     <button onclick="app.filterAdmin('Post')" class="px-5 py-2 bg-green-400/20 text-green-700 rounded-full text-sm font-semibold border border-green-400/30 backdrop-blur shadow-sm">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button>
                     <button onclick="app.filterAdmin('Draft')" class="px-5 py-2 bg-yellow-400/20 text-yellow-700 rounded-full text-sm font-semibold border border-yellow-400/30 backdrop-blur shadow-sm">‡∏£‡πà‡∏≤‡∏á</button>
                     <button onclick="app.filterAdmin('Rented')" class="px-5 py-2 bg-red-400/20 text-red-700 rounded-full text-sm font-semibold border border-red-400/30 backdrop-blur shadow-sm">‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>
                </div>
            </div>
            <div id="adminList" class="space-y-3"></div>
        </div>

    </div>

    <!-- AI CHAT WIDGET -->
    <div class="chat-float-btn" onclick="app.toggleChat()">
        <!-- Icon/Image will be injected here by JS -->
        <i class="fas fa-comment-dots" id="chatFloatIcon"></i>
    </div>

    <div id="chatWindow" class="chat-window hidden">
        <div class="chat-header">
            <div class="bot-info">
                <!-- Icon/Image injected here -->
                <i class="fas fa-robot" id="chatHeaderIcon"></i> 
                <span id="chatHeaderName">‡∏ô‡πâ‡∏≠‡∏á Condolist AI</span>
            </div>
            <button onclick="app.toggleChat()" class="text-white hover:text-gray-200"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏î‡∏π‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üòä</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="if(event.key === 'Enter') app.sendChatMessage()">
            <button onclick="app.sendChatMessage()" class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center hover:bg-blue-600 transition"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>


    <!-- === MODALS === -->

    <!-- 1. DETAIL MODAL -->
    <div id="detailModal" class="fixed inset-0 z-[60] hidden bg-gray-900/40 backdrop-blur-md flex items-end md:items-center justify-center">
        <div class="bg-white/80 backdrop-blur-2xl w-full h-[90vh] md:h-auto md:max-w-lg md:rounded-[40px] rounded-t-[40px] overflow-hidden shadow-2xl relative flex flex-col modal-enter border border-white/50">
             <button onclick="document.getElementById('detailModal').classList.add('hidden')" class="absolute top-4 right-4 z-20 w-10 h-10 bg-black/10 hover:bg-black/20 backdrop-blur rounded-full flex items-center justify-center text-gray-700 transition"><i class="fas fa-times"></i></button>
             <div class="relative w-full aspect-square shrink-0 bg-gray-100">
                 <img id="modalMainImg" src="" class="w-full h-full object-cover">
                 <div class="absolute bottom-4 right-4 bg-black/30 backdrop-blur px-3 py-1 rounded-full text-white text-xs font-bold tracking-widest border border-white/20"><span id="imageCounter">1/1</span></div>
                 <button onclick="app.slideImage(-1)" class="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-white/40"><i class="fas fa-chevron-left"></i></button>
                 <button onclick="app.slideImage(1)" class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 bg-white/20 backdrop-blur rounded-full flex items-center justify-center text-white hover:bg-white/40"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="p-8 flex-1 overflow-y-auto">
                <div class="flex justify-between items-start mb-6"><span id="modalType" class="bg-blue-100/50 text-blue-600 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider">TYPE</span><div id="modalPrice" class="text-right"></div></div>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-white/50 p-3 rounded-2xl text-center border border-white"><p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Floor</p><p id="modalFloor" class="font-bold text-gray-800 text-lg">-</p></div>
                    <div class="bg-white/50 p-3 rounded-2xl text-center border border-white"><p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Size</p><p id="modalSize" class="font-bold text-gray-800 text-lg">-</p></div>
                    <div class="bg-white/50 p-3 rounded-2xl text-center border border-white"><p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Unit</p><p id="modalUnit" class="font-bold text-gray-800 text-lg">-</p></div>
                </div>
                <div class="mb-6 bg-white/40 p-4 rounded-2xl border border-white shadow-sm"><h3 class="text-xs font-bold text-gray-500 uppercase mb-2 tracking-wider">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3><p id="modalDesc" class="text-sm text-gray-700 leading-relaxed font-light mb-4">-</p>
                    <div class="flex gap-2 pt-3 border-t border-white/50">
                        <button onclick="app.translatePublicDescription()" class="flex-1 bg-white/60 hover:bg-white text-blue-600 py-2 rounded-xl text-xs font-bold shadow-sm transition flex items-center justify-center gap-1 border border-blue-100/50"><i class="fas fa-language"></i> Translate (EN)</button>
                    </div>
                </div>
                <div class="space-y-3"><button onclick="app.contactLine()" class="w-full line-btn py-4 rounded-2xl font-bold text-lg shadow-xl flex items-center justify-center gap-2"><i class="fab fa-line text-2xl"></i> ‡∏à‡∏≠‡∏á / ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</button></div>
            </div>
        </div>
    </div>

    <!-- 1.1 ADMIN DETAIL MODAL -->
    <div id="adminDetailModal" class="fixed inset-0 z-[65] hidden bg-gray-900/40 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white/90 backdrop-blur-2xl w-full max-w-2xl rounded-[32px] shadow-2xl overflow-hidden max-h-[90vh] flex flex-col border border-white/60 modal-enter">
            <div class="px-8 py-5 border-b border-gray-100 flex justify-between items-center bg-white/50">
                <div class="flex items-center gap-4"><h3 class="text-2xl font-bold text-gray-800" id="adminModalTitle">‡∏´‡πâ‡∏≠‡∏á</h3><span id="adminModalStatus" class="text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wide"></span></div>
                <div class="flex gap-3">
                    <button onclick="app.summarizePropertyAI()" class="w-10 h-10 rounded-full bg-white border border-purple-200 text-purple-500 hover:bg-purple-50 hover:text-purple-600 hover:shadow-md transition flex items-center justify-center" title="‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ AI"><i class="fas fa-magic"></i></button>
                    <button onclick="app.printPoster()" class="w-10 h-10 rounded-full bg-white border border-gray-200 text-gray-500 hover:text-blue-500 hover:shadow-md transition flex items-center justify-center"><i class="fas fa-print"></i></button>
                    <button onclick="app.editCurrentProperty()" class="w-10 h-10 rounded-full bg-white border border-gray-200 text-gray-500 hover:text-yellow-500 hover:shadow-md transition flex items-center justify-center"><i class="fas fa-pen"></i></button>
                    <button onclick="app.closeAdminDetail()" class="w-10 h-10 rounded-full bg-gray-200 text-gray-600 hover:bg-gray-300 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="p-8 overflow-y-auto">
                 <div class="flex flex-col md:flex-row gap-6 mb-8">
                     <div class="w-32 h-32 rounded-2xl overflow-hidden shadow-lg border-2 border-white cursor-pointer group relative" onclick="window.open(app.currentProperty.images ? JSON.parse(app.currentProperty.images)[0] : '#', '_blank')"><img id="adminModalThumb" src="" class="w-full h-full object-cover"></div>
                     <div class="flex-1 grid grid-cols-2 gap-4 text-sm bg-white/60 p-5 rounded-2xl border border-white">
                         <div><span class="text-gray-400 text-[10px] uppercase font-bold">‡∏£‡∏≤‡∏Ñ‡∏≤</span><span class="block font-bold text-xl text-blue-600" id="adminModalPrice">-</span></div>
                         <div><span class="text-gray-400 text-[10px] uppercase font-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span><span class="block font-bold text-gray-800 text-lg" id="adminModalType">-</span></div>
                         <div><span class="text-gray-400 text-[10px] uppercase font-bold">‡∏Ç‡∏ô‡∏≤‡∏î</span><span class="block font-bold text-gray-800" id="adminModalSize">-</span></div>
                         <div><span class="text-gray-400 text-[10px] uppercase font-bold">‡∏ä‡∏±‡πâ‡∏ô</span><span class="block font-bold text-gray-800" id="adminModalFloor">-</span></div>
                         <div class="col-span-2 text-xs text-gray-400 mt-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠: <span id="adminModalTime"></span></div>
                     </div>
                 </div>
                 <div class="bg-white/60 p-6 rounded-2xl border border-white mb-6 shadow-sm"><h4 class="font-bold text-gray-800 mb-4 text-xs uppercase tracking-widest text-blue-500">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h4><div class="flex gap-4"><button id="btnOwnerContract" onclick="app.viewContract('owner')" class="flex-1 py-3 bg-white border border-gray-100 rounded-xl shadow-sm text-sm font-medium transition disabled:opacity-50">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</button><button id="btnTenantContract" onclick="app.viewContract('tenant')" class="flex-1 py-3 bg-white border border-gray-100 rounded-xl shadow-sm text-sm font-medium transition disabled:opacity-50">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</button></div></div>
                 <div id="adminRentedSection" class="bg-red-50/80 p-6 rounded-2xl border border-red-100 hidden"><h4 class="font-bold text-red-500 mb-4 text-xs uppercase tracking-widest">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤</h4><div class="flex justify-between bg-white p-4 rounded-xl border border-red-50"><div><span class="text-[10px] text-gray-400 block uppercase">‡πÄ‡∏£‡∏¥‡πà‡∏°</span><span id="adminRentStart" class="font-bold text-gray-800">-</span></div><div><span class="text-[10px] text-gray-400 block uppercase">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</span><span id="adminRentEnd" class="font-bold text-gray-800">-</span></div></div></div>
            </div>
        </div>
    </div>
    
    <!-- 2. FORM MODAL -->
    <div id="formModal" class="fixed inset-0 z-[70] hidden bg-gray-900/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white/95 backdrop-blur w-full max-w-3xl rounded-[32px] shadow-2xl overflow-hidden max-h-[90vh] flex flex-col modal-enter">
            <div class="px-8 py-6 border-b border-gray-100 flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800" id="formTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2><button onclick="app.closeForm()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200"><i class="fas fa-times text-gray-500"></i></button></div>
            <div class="p-8 overflow-y-auto">
                <form id="propertyForm" onsubmit="app.submitProperty(event)" class="space-y-6">
                    <input type="hidden" name="id" id="inputId">
                    <div class="bg-gray-50/50 p-6 rounded-3xl border border-gray-100 space-y-4">
                        <div class="grid grid-cols-2 gap-6">
                            <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select id="inputStatus" onchange="app.handleStatusChange()" class="w-full rounded-xl border-0 bg-white shadow-sm p-3 focus:ring-2 focus:ring-blue-500"><option value="Post">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Post)</option><option value="Draft">‡∏£‡πà‡∏≤‡∏á (Draft)</option><option value="Rented">‡∏ï‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Rented)</option></select></div>
                            <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="inputType" onchange="app.handleTypeChange()" class="w-full rounded-xl border-0 bg-white shadow-sm p-3 focus:ring-2 focus:ring-blue-500"><option value="Studio">Studio</option><option value="1BED">1 Bedroom</option><option value="2BED">2 Bedroom</option><option value="Facility">Facility (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á)</option></select></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡πÄ‡∏•‡∏Ç‡∏´‡πâ‡∏≠‡∏á</label><input type="text" id="inputUnit" required class="w-full rounded-xl border-gray-200 p-3 shadow-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡∏ä‡∏±‡πâ‡∏ô</label><input type="text" id="inputFloor" class="w-full rounded-xl border-gray-200 p-3 shadow-sm"></div>
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡∏Ç‡∏ô‡∏≤‡∏î (‡∏ï‡∏£.‡∏°.)</label><input type="text" id="inputSize" class="w-full rounded-xl border-gray-200 p-3 shadow-sm"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</label><select id="inputSaleType" class="w-full rounded-xl border-gray-200 p-3 shadow-sm"><option value="Rent">‡πÄ‡∏ä‡πà‡∏≤</option><option value="Sell">‡∏Ç‡∏≤‡∏¢</option><option value="Both">‡πÄ‡∏ä‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡∏≤‡∏¢</option></select></div>
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤</label><input type="text" id="inputPrice" required class="w-full rounded-xl border-gray-200 p-3 shadow-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15,000"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-end mb-2"><label class="block text-xs font-bold text-gray-400 uppercase">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><div class="flex gap-2"><button type="button" onclick="app.generateAIDescription()" class="text-xs font-bold text-purple-600 bg-purple-50 px-3 py-1.5 rounded-full hover:bg-purple-100 transition flex items-center gap-1 shadow-sm border border-purple-100"><i class="fas fa-magic"></i> ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button><button type="button" onclick="app.translateDescription()" class="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition flex items-center gap-1 shadow-sm border border-blue-100"><i class="fas fa-language"></i> ‡πÅ‡∏õ‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</button></div></div>
                        <textarea id="inputDesc" rows="4" class="w-full rounded-xl border-gray-200 p-3 shadow-sm text-sm focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 transition" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô..."></textarea>
                    </div>
                    <div class="space-y-4 pt-2">
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label><input type="file" id="inputImages" multiple accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
                        <div class="bg-gray-100/50 p-4 rounded-xl"><label class="block text-xs font-bold text-gray-400 uppercase mb-2">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</label><div id="existingOwnerContracts" class="flex flex-wrap gap-2 mb-2"></div><input type="file" id="inputOwnerContract" multiple accept="image/*,.pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-white"><p class="text-[10px] text-gray-400 mt-1">*‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ (‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢)</p></div>
                    </div>
                    <div id="rentedFields" class="hidden bg-red-50 p-6 rounded-3xl border border-red-100 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-red-400 uppercase mb-1">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label><input type="date" id="inputRentStart" class="w-full rounded-xl border-red-100 bg-white"></div>
                            <div><label class="text-xs font-bold text-red-400 uppercase mb-1">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</label><input type="date" id="inputRentEnd" class="w-full rounded-xl border-red-100 bg-white"></div>
                        </div>
                        <div><label class="text-xs font-bold text-red-400 uppercase mb-2 block">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</label><div id="existingTenantContracts" class="flex flex-wrap gap-2 mb-2"></div><input type="file" id="inputTenantContract" multiple accept="image/*,.pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-white"><p class="text-[10px] text-red-300 mt-1">*‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏â‡∏ö‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p></div>
                    </div>
                    <div class="pt-4 flex gap-4"><button type="submit" class="flex-1 ios-btn py-4 rounded-2xl font-bold shadow-xl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button><button type="button" id="btnDeleteProperty" onclick="app.deleteCurrentProperty()" class="w-14 bg-red-50 text-red-500 rounded-2xl flex items-center justify-center hover:bg-red-100 hidden"><i class="fas fa-trash-alt"></i></button></div>
                </form>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const app = {
            data: [],
            settings: {},
            aiContext: {}, // New: AI Settings state
            currentProperty: null,
            isAdmin: false,
            currentFiles: { images: [], owner: [], tenant: [] }, 

            init: async () => {
                await app.fetchData();
                app.loadAISettings(); // Load AI settings on init
                
                // Login persistence check
                const isAdmin = localStorage.getItem('condolist_is_admin');
                if (isAdmin === 'true') {
                    app.isAdmin = true;
                    // Wait a bit for DOM to be ready before toggling view if needed
                    setTimeout(() => app.toggleAdminView(true), 100);
                }

                window.onclick = function(event) {
                    if (!event.target.matches('.fa-bars') && !event.target.closest('button')) {
                         const nav = document.getElementById("navDropdown");
                         if(!nav.classList.contains('hidden')) {
                             nav.classList.add('opacity-0', 'scale-95');
                             setTimeout(() => nav.classList.add('hidden'), 200);
                         }
                    }
                }
            },
            
            fetchData: async () => {
                app.toggleLoading(true);
                if (GAS_API_URL.includes("placeholder")) {
                    await app.loadMockData();
                    app.toggleLoading(false);
                    return;
                }
                try {
                    const res = await fetch(`${GAS_API_URL}?action=getData`);
                    const json = await res.json();
                    if(json.status === "success") {
                        app.data = json.properties;
                        app.settings = json.settings;
                        app.applySettings();
                        app.render();
                    } else { throw new Error("Server Error"); }
                } catch (e) { await app.loadMockData(); }
                app.toggleLoading(false);
            },
            
            loadMockData: async () => {
                await new Promise(r => setTimeout(r, 800));
                app.data = MOCK_PROPERTIES;
                app.settings = MOCK_SETTINGS;
                app.applySettings();
                app.render();
            },

            applySettings: () => {
                if(app.settings.profileName) document.getElementById('profileName').innerText = app.settings.profileName;
                if(app.settings.profileDesc) document.getElementById('profileDesc').innerText = app.settings.profileDesc;
                if(app.settings.profileImage) document.getElementById('profileImg').src = app.settings.profileImage;
                if(app.settings.lineUrl) document.getElementById('btnLine').href = app.settings.lineUrl;
                if(app.settings.mapUrl) document.getElementById('btnMap').href = app.settings.mapUrl;
            },
            
            render: () => {
                app.renderGrid(app.data);
                app.renderAdminList(app.data);
            },

            toggleMenu: () => {
                const menu = document.getElementById("navDropdown");
                if (menu.classList.contains('hidden')) {
                    menu.classList.remove('hidden');
                    setTimeout(() => menu.classList.remove('opacity-0', 'scale-95'), 10);
                } else {
                    menu.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => menu.classList.add('hidden'), 200);
                }
                
                if(app.isAdmin) {
                    document.getElementById("publicMenu").classList.add("hidden");
                    document.getElementById("adminMenu").classList.remove("hidden");
                } else {
                    document.getElementById("publicMenu").classList.remove("hidden");
                    document.getElementById("adminMenu").classList.add("hidden");
                }
            },

            renderGrid: (items) => {
                const grid = document.getElementById("propertyGrid");
                grid.innerHTML = "";
                const displayItems = items.filter(i => i.status === "Post");
                
                if(displayItems.length === 0) {
                    document.getElementById("emptyState").classList.remove("hidden");
                    return;
                }
                document.getElementById("emptyState").classList.add("hidden");

                displayItems.forEach(item => {
                    const images = JSON.parse(item.images || "[]");
                    const cover = images.length > 0 ? images[0] : "https://via.placeholder.com/300?text=No+Image";
                    
                    const el = document.createElement("div");
                    el.className = "grid-square bg-white shadow-sm border border-white/50 cursor-pointer overflow-hidden";
                    el.onclick = () => app.openDetail(item);
                    el.innerHTML = `
                        <img src="${cover}" loading="lazy" class="transition duration-500 hover:scale-110">
                        ${item.type === 'Facility' ? '<div class="absolute top-2 right-2 bg-blue-500/80 backdrop-blur text-white text-[9px] px-2 py-1 rounded-full shadow-lg font-bold tracking-wider">FACILITY</div>' : ''}
                    `;
                    grid.appendChild(el);
                });
            },

            filter: (type) => {
                document.querySelectorAll('.filter-item').forEach(el => {
                    const ring = el.querySelector('.ring-wrapper');
                    const text = el.querySelector('span');
                    
                    ring.classList.remove('filter-ring-active');
                    text.classList.remove('text-blue-600', 'font-bold');
                    text.classList.add('text-gray-500');
                    
                    if (el.dataset.type === type) {
                        ring.classList.add('filter-ring-active');
                        text.classList.add('text-blue-600', 'font-bold');
                        text.classList.remove('text-gray-500');
                    }
                });

                let filtered = app.data;
                if(type !== "All") filtered = app.data.filter(i => i.type === type);
                app.renderGrid(filtered);
            },

            // --- AI CHAT LOGIC ---
            toggleChat: () => {
                const win = document.getElementById("chatWindow");
                if(win.classList.contains("hidden")) {
                    win.classList.remove("hidden");
                } else {
                    win.classList.add("hidden");
                }
            },
            
            loadAISettings: () => {
                const saved = localStorage.getItem('condolist_ai_context');
                if(saved) {
                    app.aiContext = JSON.parse(saved);
                } else {
                    app.aiContext = {
                        botName: "‡∏ô‡πâ‡∏≠‡∏á Condolist AI",
                        botIcon: "", 
                        terms: "",
                        appointment: "",
                        nearby: "",
                        rules: "",
                        others: ""
                    };
                }
                app.updateChatBranding();
            },
            
            saveAISettings: () => {
                localStorage.setItem('condolist_ai_context', JSON.stringify(app.aiContext));
                app.updateChatBranding();
            },

            updateChatBranding: () => {
                const floatBtn = document.querySelector('.chat-float-btn');
                const headerInfo = document.querySelector('.bot-info');
                
                document.getElementById('chatHeaderName').innerText = app.aiContext.botName || "‡∏ô‡πâ‡∏≠‡∏á Condolist AI";
                
                if (app.aiContext.botIcon) {
                    floatBtn.innerHTML = `<img src="${app.aiContext.botIcon}">`;
                    const currentHeaderContent = document.getElementById('chatHeaderName').outerHTML;
                    headerInfo.innerHTML = `<img src="${app.aiContext.botIcon}"> ${currentHeaderContent}`;
                } else {
                    floatBtn.innerHTML = `<i class="fas fa-comment-dots"></i>`;
                    const currentHeaderContent = document.getElementById('chatHeaderName').outerHTML;
                    headerInfo.innerHTML = `<i class="fas fa-robot" style="font-size: 20px;"></i> ${currentHeaderContent}`;
                }
            },
            
            showAISettings: async () => {
                app.toggleMenu();
                
                const { value: formValues } = await Swal.fire({
                    title: '<span class="gradient-text text-xl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏≠‡∏á & ‡∏ï‡∏±‡∏ß‡∏ï‡∏ô AI</span>',
                    customClass: {
                        popup: 'ultra-glass rounded-[32px] border border-white/50 backdrop-blur-xl',
                        confirmButton: 'ios-btn px-6 py-3 rounded-xl shadow-lg border-0 w-full mt-4',
                        cancelButton: 'bg-gray-100 text-gray-500 px-6 py-3 rounded-xl hover:bg-gray-200 border-0 w-full mt-2',
                        htmlContainer: 'text-left' 
                    },
                    html: `
                        <div class="space-y-4">
                            <!-- Bot Identity Section -->
                            <div class="bg-blue-50/50 p-4 rounded-2xl border border-blue-100">
                                <label class="block text-[10px] font-bold text-blue-500 uppercase mb-2">‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ô‡πâ‡∏≠‡∏á AI</label>
                                <div class="flex items-center gap-4 mb-3">
                                    <div class="relative w-16 h-16 shrink-0">
                                        <img src="${app.aiContext.botIcon || 'https://via.placeholder.com/150?text=AI'}" id="ai-icon-preview" class="w-16 h-16 rounded-full object-cover border-2 border-white shadow-sm bg-gray-200">
                                        <div class="absolute bottom-0 right-0 bg-white rounded-full p-1 shadow-sm border border-gray-100 cursor-pointer" onclick="document.getElementById('ai-icon-input').click()">
                                            <i class="fas fa-camera text-gray-500 text-xs"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <input id="ai-name" class="w-full rounded-xl border border-gray-200 p-2 text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡πâ‡∏≠‡∏á AI (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡πâ‡∏≠‡∏á‡∏™‡πâ‡∏°)" value="${app.aiContext.botName || ''}">
                                    </div>
                                </div>
                                <input type="file" id="ai-icon-input" class="hidden" accept="image/*" onchange="previewAIIcon(this)">
                                <input type="hidden" id="ai-icon-base64" value="${app.aiContext.botIcon || ''}">
                            </div>

                            <!-- Knowledge Section -->
                            <div class="space-y-3">
                                <p class="text-xs text-gray-400 font-bold uppercase">‡∏ä‡∏∏‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (Knowledge)</p>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡∏°‡∏±‡∏î‡∏à‡∏≥/‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤)</label>
                                    <textarea id="ai-terms" class="w-full rounded-xl border border-gray-200 p-2 text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏±‡∏ç‡∏ç‡∏≤ 1 ‡∏õ‡∏µ ‡∏°‡∏±‡∏î‡∏à‡∏≥ 2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...">${app.aiContext.terms || ''}</textarea>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏î‡∏π‡∏´‡πâ‡∏≠‡∏á</label>
                                    <textarea id="ai-appointment" class="w-full rounded-xl border border-gray-200 p-2 text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏±‡∏î‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 1 ‡∏ß‡∏±‡∏ô...">${app.aiContext.appointment || ''}</textarea>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á/‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏ó‡∏≥‡πÄ‡∏•</label>
                                    <textarea id="ai-nearby" class="w-full rounded-xl border border-gray-200 p-2 text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏Å‡∏•‡πâ BTS ‡∏≠‡πÇ‡∏®‡∏Å...">${app.aiContext.nearby || ''}</textarea>
                                </div>
                                 <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                                    <textarea id="ai-rules" class="w-full rounded-xl border border-gray-200 p-2 text-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå...">${app.aiContext.rules || ''}</textarea>
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 text-purple-500">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ (Optional)</label>
                                    <textarea id="ai-others" class="w-full rounded-xl border border-purple-200 p-2 text-sm bg-purple-50/30" placeholder="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ AI ‡∏£‡∏π‡πâ...">${app.aiContext.others || ''}</textarea>
                                </div>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    focusConfirm: false,
                    didOpen: () => {
                        window.previewAIIcon = (input) => {
                            if (input.files && input.files[0]) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    document.getElementById('ai-icon-preview').src = e.target.result;
                                    document.getElementById('ai-icon-base64').value = e.target.result; 
                                }
                                reader.readAsDataURL(input.files[0]);
                            }
                        }
                    },
                    preConfirm: () => {
                        return {
                            botName: document.getElementById('ai-name').value,
                            botIcon: document.getElementById('ai-icon-base64').value,
                            terms: document.getElementById('ai-terms').value,
                            appointment: document.getElementById('ai-appointment').value,
                            nearby: document.getElementById('ai-nearby').value,
                            rules: document.getElementById('ai-rules').value,
                            others: document.getElementById('ai-others').value
                        }
                    }
                });
                
                if (formValues) {
                    app.aiContext = formValues;
                    app.saveAISettings();
                    Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false, customClass: { popup: 'ultra-glass rounded-[32px]' } });
                }
            },

            sendChatMessage: async () => {
                const input = document.getElementById("chatInput");
                const text = input.value.trim();
                if(!text) return;
                
                const messagesDiv = document.getElementById("chatMessages");
                messagesDiv.innerHTML += `<div class="message user">${text}</div>`;
                input.value = "";
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                const loadingId = "typing-" + Date.now();
                messagesDiv.innerHTML += `<div class="message ai typing-indicator" id="${loadingId}"><span></span><span></span><span></span></div>`;
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                const availableRooms = app.data.filter(r => r.status === 'Post').map(r => {
                    return `- Unit ${r.unit}: ${r.type}, ‡∏ä‡∏±‡πâ‡∏ô ${r.floor}, ${r.size}‡∏ï‡∏£‡∏°., ‡∏£‡∏≤‡∏Ñ‡∏≤ ${r.price} (${r.saleType}), ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô: ${r.description || '-'}`;
                }).join("\n");

                const botName = app.aiContext.botName || "‡∏ô‡πâ‡∏≠‡∏á Condolist";
                const contextPrompt = `
                    ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "${botName}" ‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏Ç‡∏≤‡∏¢‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
                    
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏°‡∏µ‡∏Ç‡∏≤‡∏¢/‡πÄ‡∏ä‡πà‡∏≤ (Inventory):
                    ${availableRooms}
                    
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö/‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (Policy):
                    - ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ${app.aiContext.terms || "‡∏ï‡∏≤‡∏°‡∏ï‡∏Å‡∏•‡∏á"}
                    - ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢: ${app.aiContext.appointment || "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô"}
                    - ‡∏ó‡∏≥‡πÄ‡∏•: ${app.aiContext.nearby || "‡∏ó‡∏≥‡πÄ‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏∞‡∏î‡∏ß‡∏Å"}
                    - ‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö: ${app.aiContext.rules || "-"}
                    - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${app.aiContext.others || "-"}
                    
                    ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: "${text}"
                    
                    ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
                    1. ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏´‡∏≤‡∏´‡πâ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å "Inventory" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 2-3 ‡∏´‡πâ‡∏≠‡∏á)
                    2. ‡∏ö‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à (‡πÄ‡∏ä‡πà‡∏ô "‡∏Ç‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡πâ‡∏≠‡∏á A ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á ‡∏ß‡∏¥‡∏ß‡∏™‡∏ß‡∏¢ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏á‡∏ö")
                    3. ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û
                    4. ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤/‡∏ó‡∏≥‡πÄ‡∏• ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "Policy"
                    5. ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏∞‡∏™‡∏•‡∏ß‡∏¢ ‡∏°‡∏µ Emoji ‡∏ö‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£ 
                    6. ‡πÅ‡∏ó‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤ "${botName}" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ô‡πâ‡∏≠‡∏á"
                    
                    ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:
                `;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: contextPrompt }] }] })
                    });
                    const data = await response.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ô‡πâ‡∏≠‡∏á‡∏°‡∏∂‡∏ô‡∏´‡∏±‡∏ß‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢ ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡πâ‡∏≤‡∏ö üòÖ";
                    
                    document.getElementById(loadingId).remove();
                    
                    const formattedReply = reply.replace(/\n/g, '<br>');
                    messagesDiv.innerHTML += `<div class="message ai">${formattedReply}</div>`;
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    
                } catch (e) {
                    if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                    messagesDiv.innerHTML += `<div class="message ai text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>`;
                }
            },

            openDetail: (item) => {
                app.currentProperty = item;
                
                if (app.isAdmin) {
                    const modal = document.getElementById("adminDetailModal");
                    const images = JSON.parse(item.images || "[]");
                    const thumb = images.length > 0 ? images[0] : "https://via.placeholder.com/150?text=No+Image";
                    
                    const cleanUnit = item.unit.replace(/\(Both\)/gi, '').replace(/\(both\)/gi, '').trim();
                    document.getElementById("adminModalTitle").innerText = "‡∏´‡πâ‡∏≠‡∏á " + cleanUnit;
                    
                    const statusEl = document.getElementById("adminModalStatus");
                    statusEl.innerText = item.status;
                    statusEl.className = "text-xs px-3 py-1 rounded-full font-bold uppercase tracking-wide ";
                    if(item.status === 'Post') statusEl.classList.add('bg-green-100', 'text-green-600');
                    else if(item.status === 'Draft') statusEl.classList.add('bg-yellow-100', 'text-yellow-600');
                    else statusEl.classList.add('bg-red-100', 'text-red-600');
                    
                    document.getElementById("adminModalThumb").src = thumb;
                    document.getElementById("adminModalPrice").innerText = "‡∏ø" + item.price;
                    document.getElementById("adminModalType").innerText = item.type;
                    document.getElementById("adminModalSize").innerText = item.size + " ‡∏ï‡∏£.‡∏°.";
                    document.getElementById("adminModalFloor").innerText = item.floor;
                    document.getElementById("adminModalTime").innerText = new Date(item.timestamp).toLocaleDateString('th-TH');

                    const setupBtn = (btnId, contractsJson, label) => {
                        const btn = document.getElementById(btnId);
                        let files = [];
                        try { files = JSON.parse(contractsJson || "[]"); } catch(e) { if(contractsJson) files = [contractsJson]; }
                        
                        if (files.length > 0) {
                            btn.disabled = false;
                            const countBadge = files.length > 1 ? ` <span class="bg-blue-100 text-blue-600 px-1.5 rounded-full text-xs ml-1">${files.length}</span>` : '';
                            btn.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i> ${label}${countBadge}`;
                            btn.classList.add('text-green-700', 'bg-green-50');
                        } else {
                            btn.disabled = true;
                            btn.innerHTML = `<i class="fas fa-times-circle text-gray-300 mr-2"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£`;
                            btn.classList.remove('text-green-700', 'bg-green-50');
                        }
                    };
                    
                    setupBtn("btnOwnerContract", item.contractOwner, "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á");
                    setupBtn("btnTenantContract", item.contractTenant, "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤");

                    if (item.status === 'Rented') {
                        document.getElementById("adminRentedSection").classList.remove("hidden");
                        document.getElementById("adminRentStart").innerText = item.rentedStart || "-";
                        document.getElementById("adminRentEnd").innerText = item.rentedEnd || "-";
                    } else {
                        document.getElementById("adminRentedSection").classList.add("hidden");
                    }
                    modal.classList.remove("hidden");

                } else {
                    const modal = document.getElementById("detailModal");
                    const images = JSON.parse(item.images || "[]");
                    
                    document.getElementById("modalType").innerText = item.type;
                    document.getElementById("modalDesc").innerText = item.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°";

                    const modalPriceEl = document.getElementById("modalPrice");
                    if (item.saleType === 'Both' && item.price.includes('/')) {
                         const parts = item.price.split('/');
                         modalPriceEl.innerHTML = `
                            <div class="flex flex-col items-end">
                                <span class="text-blue-600 font-bold text-lg">‡∏ø${parts[0].trim()} <span class="text-xs text-gray-400 font-normal">/‡πÄ‡∏ä‡πà‡∏≤</span></span>
                                <span class="text-pink-600 font-bold text-lg">‡∏ø${parts[1].trim()} <span class="text-xs text-gray-400 font-normal">/‡∏Ç‡∏≤‡∏¢</span></span>
                            </div>`;
                    } else {
                         const label = item.saleType === 'Rent' ? '/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' : '';
                         if(item.price === 'Free') modalPriceEl.innerHTML = `<span class="text-green-500 font-bold text-2xl">‡∏ü‡∏£‡∏µ</span>`;
                         else modalPriceEl.innerHTML = `<span class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-pink-600">‡∏ø${item.price}<span class="text-sm text-gray-400 font-normal ml-1">${label}</span></span>`;
                    }

                    const cleanUnit = item.unit.replace(/\(Both\)/gi, '').replace(/\(both\)/gi, '').trim();
                    document.getElementById("modalUnit").innerText = cleanUnit;
                    document.getElementById("modalFloor").innerText = item.floor;
                    document.getElementById("modalSize").innerText = item.size;

                    app.currentImageIndex = 0;
                    app.currentImages = images.length > 0 ? images : ["https://via.placeholder.com/500?text=No+Image"];
                    app.updateSlide();
                    
                    modal.classList.remove("hidden");
                }
            },

            closeAdminDetail: () => { document.getElementById("adminDetailModal").classList.add("hidden"); },
            
            viewContract: async (type) => {
                const item = app.currentProperty;
                let jsonStr = (type === 'owner') ? item.contractOwner : item.contractTenant;
                let files = [];
                try { files = JSON.parse(jsonStr || "[]"); } catch(e) { if(jsonStr) files = [jsonStr]; }

                if (files.length === 0) return;

                if (files.length === 1) {
                    window.open(files[0], '_blank');
                } else {
                    const { value: selectedUrl } = await Swal.fire({
                        title: `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå${type === 'owner' ? '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á' : '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤'}`,
                        input: 'radio',
                        inputOptions: files.reduce((acc, url, index) => {
                            acc[url] = `‡∏â‡∏ö‡∏±‡∏ö‡∏ó‡∏µ‡πà ${index + 1} (‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå)`;
                            return acc;
                        }, {}),
                        inputValue: files[files.length-1], 
                        customClass: { popup: 'ultra-glass rounded-[32px]' },
                        confirmButtonText: '‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå',
                        showCancelButton: true,
                        cancelButtonText: '‡∏õ‡∏¥‡∏î'
                    });

                    if (selectedUrl) {
                        window.open(selectedUrl, '_blank');
                    }
                }
            },

            slideImage: (dir) => {
                app.currentImageIndex += dir;
                if(app.currentImageIndex < 0) app.currentImageIndex = app.currentImages.length - 1;
                if(app.currentImageIndex >= app.currentImages.length) app.currentImageIndex = 0;
                app.updateSlide();
            },

            updateSlide: () => {
                document.getElementById("modalMainImg").src = app.currentImages[app.currentImageIndex];
                document.getElementById("imageCounter").innerText = `${app.currentImageIndex + 1}/${app.currentImages.length}`;
            },

            contactLine: () => { window.open(app.settings.lineUrl, '_blank'); },

            toggleLoading: (show) => {
                const el = document.getElementById("loadingOverlay");
                if(show) el.classList.remove("hidden");
                else el.classList.add("hidden");
            },

            showLogin: async () => {
                const { value: password } = await Swal.fire({
                    title: '<span class="gradient-text text-2xl">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span>',
                    customClass: {
                        popup: 'ultra-glass rounded-[32px] border border-white/50 backdrop-blur-xl p-0 pb-6',
                        title: 'pt-8', 
                        confirmButton: 'ios-btn px-6 py-3 rounded-xl shadow-lg border-0 w-full mt-4 text-base',
                        cancelButton: 'bg-white/50 text-gray-500 hover:text-gray-700 px-6 py-3 rounded-xl border-0 w-full mt-2 text-sm',
                        actions: 'flex flex-col w-full px-8 pb-4 gap-0', 
                        htmlContainer: '!overflow-visible px-8 m-0' 
                    },
                    buttonsStyling: false,
                    html: `
                        <div class="flex flex-col items-center gap-4 mt-2 mb-2">
                            <div class="relative w-24 h-24 mb-2">
                                <div class="absolute inset-0 bg-blue-500/20 rounded-full blur-xl animate-pulse"></div>
                                <div class="relative w-full h-full rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-inner border border-white/20">
                                    <i class="fas fa-lock text-4xl text-white drop-shadow-md"></i>
                                </div>
                                <div class="absolute top-0 right-0 w-6 h-6 bg-white/30 rounded-full blur-[2px]"></div>
                            </div>
                            <p class="text-sm text-gray-500 font-light text-center leading-relaxed">
                                ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
                            </p>
                            <div class="relative w-full group">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fas fa-key text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                                </div>
                                <input id="swal-password" type="password" 
                                    class="w-full rounded-2xl border-0 bg-white/60 p-4 pl-11 shadow-inner text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-blue-500/50 focus:bg-white transition-all outline-none text-center tracking-widest text-lg" 
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    focusConfirm: false,
                    didOpen: () => {
                        const input = document.getElementById('swal-password');
                        if(input) {
                            input.focus();
                            input.addEventListener('keyup', (event) => {
                                if (event.key === 'Enter') {
                                    Swal.clickConfirm();
                                }
                            });
                        }
                    },
                    preConfirm: () => {
                        return document.getElementById('swal-password').value;
                    }
                });

                if (password) {
                    if(GAS_API_URL.includes("placeholder")) {
                         if(password === "1234") {
                            app.isAdmin = true;
                            app.toggleAdminView(true);
                            Swal.fire({ 
                                icon: 'success', 
                                title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', 
                                timer: 1500, 
                                showConfirmButton: false,
                                customClass: { popup: 'ultra-glass rounded-[32px]' }
                            });
                            // Save to local storage
                            localStorage.setItem('condolist_is_admin', 'true');
                         } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î',
                                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                                customClass: { popup: 'ultra-glass rounded-[32px]', confirmButton: 'ios-btn px-6 py-2 rounded-xl' }
                            });
                         }
                         return;
                    }
                    
                    try {
                        const res = await fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'login', password: password })
                        });
                        const json = await res.json();
                        if (json.status === "success") {
                            app.isAdmin = true;
                            localStorage.setItem('condolist_is_admin', 'true');
                            app.toggleAdminView(true);
                            Swal.fire({ 
                                icon: 'success', 
                                title: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö', 
                                timer: 1500, 
                                showConfirmButton: false,
                                customClass: { popup: 'ultra-glass rounded-[32px]' }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
                                customClass: { popup: 'ultra-glass rounded-[32px]', confirmButton: 'ios-btn px-6 py-2 rounded-xl' }
                            });
                        }
                    } catch(e) {
                         Swal.fire("Error", "Login Error", "error");
                    }
                }
            },

            logout: () => {
                app.isAdmin = false;
                localStorage.removeItem('condolist_is_admin');
                app.toggleAdminView(false);
                app.toggleMenu();
            },

            toggleAdminView: (showAdmin) => {
                const publicView = document.getElementById("publicView");
                const adminDashboard = document.getElementById("adminDashboard");
                if(showAdmin) {
                    publicView.classList.add("hidden");
                    adminDashboard.classList.remove("hidden");
                    app.renderAdminList(app.data);
                } else {
                    publicView.classList.remove("hidden");
                    adminDashboard.classList.add("hidden");
                    app.renderGrid(app.data);
                }
                const nav = document.getElementById("navDropdown");
                nav.classList.add('opacity-0', 'scale-95');
                setTimeout(() => nav.classList.add('hidden'), 200);
            },

            renderAdminList: (items) => {
                const container = document.getElementById("adminList");
                container.innerHTML = "";
                items.forEach(item => {
                    let statusColor = item.status === 'Post' ? 'border-green-400' : (item.status === 'Draft' ? 'border-yellow-400' : 'border-red-400');
                    const el = document.createElement("div");
                    el.className = `glass-card p-4 flex justify-between items-center cursor-pointer border-l-4 ${statusColor} hover:bg-white/80 transition`;
                    el.onclick = () => app.openDetail(item);
                    el.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400 font-bold text-xs">${item.unit.substring(0,3)}</div>
                            <div>
                                <div class="font-bold text-gray-800 text-lg leading-tight">${item.unit}</div>
                                <div class="text-xs text-gray-500">${item.type} ‚Ä¢ ${item.floor}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-blue-600">‡∏ø${item.price}</div>
                            <div class="text-[10px] uppercase font-bold text-gray-400">${item.status}</div>
                        </div>
                    `;
                    container.appendChild(el);
                });
            },
            
            filterAdmin: (status) => {
                let filtered = app.data;
                if(status !== 'All') filtered = app.data.filter(i => i.status === status);
                app.renderAdminList(filtered);
            },

            // --- FORM (Styling only) ---
            showAddRoom: () => {
                document.getElementById("propertyForm").reset();
                document.getElementById("formTitle").innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà";
                document.getElementById("inputId").value = "";
                document.getElementById("imagePreview").innerHTML = "";
                document.getElementById("existingOwnerContracts").innerHTML = "";
                document.getElementById("existingTenantContracts").innerHTML = "";
                app.currentFiles = { images: [], owner: [], tenant: [] };
                
                document.getElementById("btnDeleteProperty").classList.add("hidden");
                document.getElementById("formModal").classList.remove("hidden");
                document.getElementById("rentedFields").classList.add("hidden");
                app.toggleMenu();
            },

            editCurrentProperty: () => {
                const item = app.currentProperty;
                document.getElementById("adminDetailModal").classList.add("hidden");
                document.getElementById("formModal").classList.remove("hidden");
                document.getElementById("formTitle").innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
                document.getElementById("btnDeleteProperty").classList.remove("hidden");
                
                document.getElementById("inputId").value = item.id;
                document.getElementById("inputStatus").value = item.status;
                document.getElementById("inputType").value = item.type;
                document.getElementById("inputUnit").value = item.unit;
                document.getElementById("inputFloor").value = item.floor;
                document.getElementById("inputSize").value = item.size;
                document.getElementById("inputSaleType").value = item.saleType;
                document.getElementById("inputPrice").value = item.price;
                document.getElementById("inputDesc").value = item.description || "";
                
                app.handleStatusChange();
                if(item.status === 'Rented') {
                    if(item.rentedStart) document.getElementById("inputRentStart").value = new Date(item.rentedStart).toISOString().split('T')[0];
                    if(item.rentedEnd) document.getElementById("inputRentEnd").value = new Date(item.rentedEnd).toISOString().split('T')[0];
                }
                
                app.currentFiles = { images: [], owner: [], tenant: [] };
                
                const renderChips = (jsonStr, containerId, typeKey) => {
                    let files = [];
                    try { files = JSON.parse(jsonStr || "[]"); } catch(e) { if(jsonStr) files = [jsonStr]; }
                    app.currentFiles[typeKey] = files;

                    const container = document.getElementById(containerId);
                    container.innerHTML = "";
                    files.forEach((url, index) => {
                        const chip = document.createElement("div");
                        chip.className = "flex items-center gap-2 bg-white border px-3 py-1 rounded-full text-xs shadow-sm";
                        chip.innerHTML = `
                            <a href="${url}" target="_blank" class="text-blue-600 hover:underline truncate max-w-[100px]">‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${index + 1}</a>
                            <button type="button" onclick="app.removeFile('${typeKey}', ${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                        `;
                        container.appendChild(chip);
                    });
                };

                renderChips(item.contractOwner, "existingOwnerContracts", "owner");
                renderChips(item.contractTenant, "existingTenantContracts", "tenant");
            },

            removeFile: (type, index) => {
                app.currentFiles[type].splice(index, 1);
                const containerId = type === 'owner' ? "existingOwnerContracts" : "existingTenantContracts";
                const container = document.getElementById(containerId);
                container.innerHTML = "";
                app.currentFiles[type].forEach((url, i) => {
                    const chip = document.createElement("div");
                    chip.className = "flex items-center gap-2 bg-white border px-3 py-1 rounded-full text-xs shadow-sm";
                    chip.innerHTML = `
                        <a href="${url}" target="_blank" class="text-blue-600 hover:underline truncate max-w-[100px]">‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${i + 1}</a>
                        <button type="button" onclick="app.removeFile('${type}', ${i})" class="text-red-400 hover:text-red-600"><i class="fas fa-times"></i></button>
                    `;
                    container.appendChild(chip);
                });
            },

            handleStatusChange: () => {
                const status = document.getElementById("inputStatus").value;
                const rentedFields = document.getElementById("rentedFields");
                if (status === "Rented") rentedFields.classList.remove("hidden");
                else rentedFields.classList.add("hidden");
            },
            
            handleTypeChange: () => {
                 const type = document.getElementById("inputType").value;
                 if(type === 'Facility') document.getElementById("inputPrice").value = "Free";
            },

            closeForm: () => { document.getElementById("formModal").classList.add("hidden"); },

            submitProperty: async (e) => {
                e.preventDefault();
                app.toggleLoading(true);
                
                const getNewFilesBase64 = async (inputId) => {
                    const input = document.getElementById(inputId);
                    if (input.files.length > 0) {
                        return await Promise.all([...input.files].map(file => app.fileToBase64(file)));
                    }
                    return [];
                };

                const newOwnerFiles = await getNewFilesBase64('inputOwnerContract');
                const newTenantFiles = await getNewFilesBase64('inputTenantContract');
                const newImages = await getNewFilesBase64('inputImages');

                const finalOwnerContracts = [...app.currentFiles.owner, ...newOwnerFiles];
                const finalTenantContracts = [...app.currentFiles.tenant, ...newTenantFiles];
                
                let finalImages = app.currentProperty ? JSON.parse(app.currentProperty.images || "[]") : [];
                if(document.getElementById("inputId").value === "") finalImages = [];
                finalImages = [...finalImages, ...newImages];

                const payload = {
                    id: document.getElementById("inputId").value || Date.now().toString(),
                    status: document.getElementById("inputStatus").value,
                    type: document.getElementById("inputType").value,
                    unit: document.getElementById("inputUnit").value,
                    floor: document.getElementById("inputFloor").value,
                    size: document.getElementById("inputSize").value,
                    saleType: document.getElementById("inputSaleType").value,
                    price: document.getElementById("inputPrice").value,
                    description: document.getElementById("inputDesc").value,
                    images: finalImages,
                    contractOwner: finalOwnerContracts,
                    contractTenant: finalTenantContracts,
                    rentedStart: document.getElementById("inputRentStart").value,
                    rentedEnd: document.getElementById("inputRentEnd").value,
                    timestamp: new Date().toISOString()
                };
                
                if (GAS_API_URL.includes("placeholder")) {
                    const existingIndex = app.data.findIndex(p => p.id === payload.id);
                    if(existingIndex >= 0) app.data[existingIndex] = payload;
                    else app.data.unshift(payload);
                     app.closeForm();
                     app.toggleLoading(false);
                     if(app.isAdmin) app.renderAdminList(app.data);
                     else app.renderGrid(app.data);
                } else {
                     const finalPayload = { ...payload, action: "saveProperty" };
                     try {
                        const res = await fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(finalPayload)
                        });
                        const json = await res.json();
                        if(json.status === "success") {
                            await app.fetchData();
                            app.closeForm();
                            app.toggleLoading(false);
                        } else { throw new Error(json.message); }
                    } catch(e) { Swal.fire("Error", e.message, "error"); app.toggleLoading(false); }
                }
            },

            deleteCurrentProperty: async () => {
                document.getElementById("formModal").classList.add("hidden");
            },
            
            showSettings: async () => {
                 app.toggleMenu();
                 
                 const { value: formValues } = await Swal.fire({
                    title: '<span class="gradient-text text-2xl">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>',
                    customClass: {
                        popup: 'ultra-glass rounded-[32px] border border-white/50 backdrop-blur-xl',
                        title: 'text-gray-800',
                        confirmButton: 'ios-btn px-6 py-3 rounded-xl shadow-lg border-0 w-full mt-4',
                        cancelButton: 'bg-gray-100 text-gray-500 px-6 py-3 rounded-xl hover:bg-gray-200 border-0 w-full mt-2',
                        actions: 'flex flex-col w-full px-6 pb-2 gap-0',
                        htmlContainer: '!overflow-visible px-2' 
                    },
                    html: `
                        <div class="text-left space-y-4 mt-2">
                            <div class="flex justify-center mb-4">
                                <div class="relative w-24 h-24">
                                    <img src="${app.settings.profileImage || 'https://via.placeholder.com/150'}" id="setting-preview" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-md">
                                    <div class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full p-1.5 w-8 h-8 flex items-center justify-center shadow-sm border-2 border-white">
                                        <i class="fas fa-camera text-xs"></i>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</label>
                                <input id="swal-name" class="w-full rounded-2xl border-0 bg-white/60 p-3.5 shadow-sm text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-blue-500/50 outline-none transition" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value="${app.settings.profileName || ''}">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                <textarea id="swal-desc" rows="2" class="w-full rounded-2xl border-0 bg-white/60 p-3.5 shadow-sm text-gray-800 placeholder-gray-400 focus:ring-2 focus:ring-blue-500/50 outline-none transition" placeholder="‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏±‡πâ‡∏ô‡πÜ...">${app.settings.profileDesc || ''}</textarea>
                            </div>
                            
                            <input type="file" id="swal-img-file" class="hidden" accept="image/*" onchange="previewProfileImage(this)">
                            
                            <div class="p-3 bg-white/60 rounded-2xl border border-dashed border-gray-300 text-center cursor-pointer hover:bg-white/80 transition" onclick="document.getElementById('swal-img-file').click()">
                                <p class="text-xs text-gray-500"><i class="fas fa-cloud-upload-alt mr-1"></i> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</p>
                                <input id="swal-img-url" type="hidden" value="${app.settings.profileImage || ''}">
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">‡∏•‡∏¥‡∏á‡∏Å‡πå Line</label>
                                    <input id="swal-line" class="w-full rounded-2xl border-0 bg-white/60 p-3.5 shadow-sm text-xs text-gray-800 focus:ring-2 focus:ring-blue-500/50 outline-none" value="${app.settings.lineUrl || ''}" placeholder="https://line.me/...">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</label>
                                    <input id="swal-map" class="w-full rounded-2xl border-0 bg-white/60 p-3.5 shadow-sm text-xs text-gray-800 focus:ring-2 focus:ring-blue-500/50 outline-none" value="${app.settings.mapUrl || ''}" placeholder="https://maps...">
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                                <input id="swal-pass" type="password" class="w-full rounded-2xl border-0 bg-white/60 p-3.5 shadow-sm text-gray-800 focus:ring-2 focus:ring-blue-500/50 outline-none" placeholder="‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô">
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                    focusConfirm: false,
                    didOpen: () => {
                        window.previewProfileImage = (input) => {
                            if (input.files && input.files[0]) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    document.getElementById('setting-preview').src = e.target.result;
                                    document.getElementById('swal-img-url').value = "(new_file_selected)";
                                }
                                reader.readAsDataURL(input.files[0]);
                            }
                        }
                    },
                    preConfirm: async () => {
                        let profileImage = document.getElementById('swal-img-url').value;
                        const fileInput = document.getElementById('swal-img-file');
                        
                        if (fileInput.files.length > 0) {
                            try {
                                profileImage = await app.fileToBase64(fileInput.files[0]);
                            } catch (e) {
                                Swal.showValidationMessage(`Upload failed: ${e}`);
                            }
                        }

                        return {
                            profileName: document.getElementById('swal-name').value,
                            profileDesc: document.getElementById('swal-desc').value,
                            profileImage: profileImage,
                            lineUrl: document.getElementById('swal-line').value,
                            mapUrl: document.getElementById('swal-map').value,
                            adminPassword: document.getElementById('swal-pass').value
                        }
                    }
                });

                if (formValues) {
                    app.toggleLoading(true);
                    
                     if(GAS_API_URL.includes("placeholder")) {
                        await new Promise(r => setTimeout(r, 500));
                        app.settings = { ...app.settings, ...formValues };
                        if(formValues.profileImage && formValues.profileImage.startsWith('data:')) {
                             app.settings.profileImage = formValues.profileImage;
                        }
                        app.applySettings();
                        app.toggleLoading(false);
                        Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false, customClass: { popup: 'ultra-glass rounded-[32px]' } });
                        return;
                    }

                    formValues.action = "saveSettings";
                    if(!formValues.adminPassword) delete formValues.adminPassword;
                    
                    try {
                        await fetch(GAS_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(formValues)
                        });
                        await app.fetchData();
                        Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', timer: 1500, showConfirmButton: false, customClass: { popup: 'ultra-glass rounded-[32px]' } });
                    } catch(e) {
                        Swal.fire("Error", "Failed to save", "error");
                    }
                    app.toggleLoading(false);
                }
            },

            // --- PRINTING (KEEP EXACTLY SAME LAYOUT) ---
            printPoster: () => {
                const item = app.currentProperty;
                const images = JSON.parse(item.images || "[]");
                const agentName = app.settings.profileName || "Admin";
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(app.settings.lineUrl)}`;
                
                let imagesHtml = '';
                const displayImages = images.length > 0 ? images : ["https://via.placeholder.com/600?text=No+Image"];
                
                for(let i=0; i<6; i++) {
                    const src = displayImages[i] || displayImages[0]; 
                    imagesHtml += `<div class="relative w-full h-full rounded-lg overflow-hidden border border-gray-200 bg-gray-100 shadow-sm"><img src="${src}" class="absolute inset-0 w-full h-full object-cover"></div>`;
                }

                let priceHtml = '';
                // Changed labels to Thai: Rent->‡πÄ‡∏ä‡πà‡∏≤, Sell->‡∏Ç‡∏≤‡∏¢
                const createPriceTag = (price, label) => `<div class="flex items-baseline justify-center gap-2"><span class="text-4xl font-extrabold text-pink-600">‡∏ø${price}</span><span class="text-xl text-gray-500 font-bold">(${label})</span></div>`;

                if (item.saleType === 'Both' && item.price.includes('/')) {
                     const parts = item.price.split('/');
                     priceHtml = `<div class="flex flex-col items-center justify-center gap-1">${createPriceTag(parts[0].trim(), '‡πÄ‡∏ä‡πà‡∏≤')}${createPriceTag(parts[1].trim(), '‡∏Ç‡∏≤‡∏¢')}</div>`;
                } else {
                     const label = item.saleType === 'Rent' ? '‡πÄ‡∏ä‡πà‡∏≤' : (item.saleType === 'Sell' ? '‡∏Ç‡∏≤‡∏¢' : '');
                     if(label) priceHtml = `<div class="flex flex-col items-center justify-center">${createPriceTag(item.price, label)}</div>`;
                     else priceHtml = `<div class="flex flex-col items-center justify-center"><span class="text-5xl font-extrabold text-pink-600">‡∏ø${item.price}</span></div>`;
                }

                const cleanUnit = item.unit.replace(/\(Both\)/gi, '').replace(/\(both\)/gi, '').trim();
                const printWindow = window.open('', '_blank', 'width=1123,height=794');
                
                const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Print Poster</title>
                        <script src="https://cdn.tailwindcss.com"><\/script>
                        <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
                        <style>
                            @page { size: A4 landscape; margin: 0; }
                            body { margin: 0; padding: 0; font-family: 'Sarabun', sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            .image-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 12px; height: 100%; }
                        </style>
                    </head>
                    <body class="bg-white w-full h-screen flex flex-col overflow-hidden p-6 box-border">
                        <div class="flex-1 w-full mb-4 min-h-0"><div class="image-grid">${imagesHtml}</div></div>
                        <div class="h-48 bg-gray-50 border border-gray-200 rounded-2xl p-6 flex flex-row justify-between items-center shadow-sm shrink-0">
                            <div class="w-1/3 border-r border-gray-300 pr-6 flex flex-col justify-center h-full">${priceHtml}<div class="mt-2 flex items-center justify-center gap-2"><span class="bg-gray-800 text-white text-xs px-2 py-1 rounded uppercase font-bold">‡∏´‡πâ‡∏≠‡∏á</span><span class="text-2xl font-bold text-gray-800">${cleanUnit}</span></div></div>
                            <div class="w-1/3 px-8 flex flex-col justify-center h-full">
                                <div class="grid grid-cols-2 gap-y-4 gap-x-8 text-gray-800 w-full">
                                    <div><span class="block text-[10px] text-gray-500 uppercase font-bold tracking-wider">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</span><span class="text-xl font-bold border-b-2 border-pink-100 inline-block">${item.type}</span></div>
                                    <div><span class="block text-[10px] text-gray-500 uppercase font-bold tracking-wider">‡∏ä‡∏±‡πâ‡∏ô</span><span class="text-xl font-bold border-b-2 border-pink-100 inline-block">${item.floor}</span></div>
                                    <div class="col-span-2"><span class="block text-[10px] text-gray-500 uppercase font-bold tracking-wider">‡∏Ç‡∏ô‡∏≤‡∏î</span><span class="text-3xl font-bold text-gray-900">${item.size} <small class="text-gray-500 text-base font-normal">‡∏ï‡∏£.‡∏°.</small></span></div>
                                </div>
                            </div>
                            <div class="w-1/3 flex items-center justify-end gap-6 pl-6 border-l border-gray-300 h-full">
                                 <div class="text-right"><p class="text-[10px] text-pink-600 font-bold uppercase mb-1 tracking-widest">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</p><h3 class="text-xl font-bold text-gray-900 leading-tight mb-1 truncate max-w-[180px]">${agentName}</h3><p class="text-[10px] text-gray-400 uppercase">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p></div>
                                 <div class="bg-white p-1.5 rounded-lg shadow-md border border-gray-100 shrink-0"><img src="${qrUrl}" class="w-24 h-24 object-contain"></div>
                            </div>
                        </div>
                        <script>setTimeout(() => { window.print(); }, 1000);<\/script>
                    </body>
                    </html>
                `;
                printWindow.document.write(htmlContent);
                printWindow.document.close();
            },

            // --- GEMINI AI FEATURES ---
            generateAIDescription: async () => {
                const type = document.getElementById("inputType").value;
                const floor = document.getElementById("inputFloor").value || "-";
                const size = document.getElementById("inputSize").value || "-";
                const price = document.getElementById("inputPrice").value || "-";
                const saleType = document.getElementById("inputSaleType").value;
                
                const prompt = `‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡∏≤‡∏¢/‡πÄ‡∏ä‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à ‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î) ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î‡πÅ‡∏ö‡∏ö ${type}, ‡∏ä‡∏±‡πâ‡∏ô ${floor}, ‡∏Ç‡∏ô‡∏≤‡∏î ${size} ‡∏ï‡∏£‡∏°., ‡∏£‡∏≤‡∏Ñ‡∏≤ ${price}, ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${saleType}. ‡πÄ‡∏ô‡πâ‡∏ô‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà.`;
                
                app.toggleLoading(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ";
                    document.getElementById("inputDesc").value = text.trim();
                } catch (e) {
                    Swal.fire("AI Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ‡πÑ‡∏î‡πâ", "error");
                }
                app.toggleLoading(false);
            },

            // New Function: Summarize Property for Admin
            summarizePropertyAI: async () => {
                const item = app.currentProperty;
                const prompt = `‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏Ø ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÉ‡∏™‡πà Emoji ‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≤‡∏á Line:
                - ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${item.unit}
                - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${item.type}
                - ‡∏ä‡∏±‡πâ‡∏ô: ${item.floor}
                - ‡∏Ç‡∏ô‡∏≤‡∏î: ${item.size} ‡∏ï‡∏£‡∏°.
                - ‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price} (${item.saleType})
                - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${item.status}
                - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ${item.description || '-'}
                
                ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
                üî• ‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏∏‡∏î‡∏à‡∏≠‡∏á/‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏ß‡∏¢! [‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á]
                üè¢ ‡∏ä‡∏±‡πâ‡∏ô [‡∏ä‡∏±‡πâ‡∏ô] ‡∏Ç‡∏ô‡∏≤‡∏î [‡∏Ç‡∏ô‡∏≤‡∏î]
                üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤ [‡∏£‡∏≤‡∏Ñ‡∏≤]
                ...‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô...
                üìç ‡∏™‡∏ô‡πÉ‡∏à‡∏ó‡∏±‡∏Å‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö`;

                app.toggleLoading(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
                    
                    Swal.fire({
                        title: '<span class="gradient-text">‚ú® AI ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>',
                        html: `<div class="text-left text-sm text-gray-700 whitespace-pre-line bg-gray-50 p-4 rounded-xl border border-gray-200">${text}</div>`,
                        customClass: { popup: 'ultra-glass rounded-[32px]' },
                        showCancelButton: true,
                        cancelButtonText: '‡∏õ‡∏¥‡∏î',
                        confirmButtonText: '<i class="far fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å',
                        confirmButtonColor: '#007AFF',
                    }).then((result) => {
                        if (result.isConfirmed) {
                            navigator.clipboard.writeText(text);
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                didOpen: (toast) => {
                                    toast.addEventListener('mouseenter', Swal.stopTimer)
                                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                                }
                            })
                            Toast.fire({
                                icon: 'success',
                                title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'
                            })
                        }
                    });
                } catch (e) {
                    Swal.fire("AI Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠", "error");
                }
                app.toggleLoading(false);
            },

            translatePublicDescription: async () => {
                const descElement = document.getElementById("modalDesc");
                const currentText = app.currentProperty.description || "";
                
                if (!currentText || currentText === "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°") {
                    Swal.fire("Info", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•", "info");
                    return;
                }

                // Check if already translated
                if (descElement.innerText.includes("[English Version]")) return;

                app.toggleLoading(true);
                try {
                    const prompt = `Translate this real estate description to professional and attractive English: "${currentText}"`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const translatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
                    
                    if(translatedText) {
                         descElement.innerHTML = `${currentText}<br><br><span class="text-blue-600 font-bold text-xs">[English Version]</span><br>${translatedText.replace(/\n/g, '<br>')}`;
                    }
                } catch (e) {
                    Swal.fire("Error", "Translation failed", "error");
                }
                app.toggleLoading(false);
            },

            translateDescription: async () => {
                const currentText = document.getElementById("inputDesc").value;
                if (!currentText) {
                    Swal.fire("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏õ‡∏•", "warning");
                    return;
                }

                const prompt = `Translate the following real estate description into professional, attractive English for property listing: "${currentText}"`;

                app.toggleLoading(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Translation failed";
                    
                    // ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
                    const textarea = document.getElementById("inputDesc");
                    textarea.value = textarea.value + "\n\n[English Version]\n" + text.trim();
                    textarea.scrollTop = textarea.scrollHeight; // Scroll to bottom
                } catch (e) {
                    Swal.fire("AI Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏î‡πâ", "error");
                }
                app.toggleLoading(false);
            },
            
            askAI: async () => {
                const item = app.currentProperty;
                const prompt = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏±‡πâ‡∏ô‡πÜ 3 ‡∏Ç‡πâ‡∏≠ ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ Emoji. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î ${item.type}, ‡∏ä‡∏±‡πâ‡∏ô ${item.floor}, ‡∏Ç‡∏ô‡∏≤‡∏î ${item.size} ‡∏ï‡∏£‡∏°., ‡∏£‡∏≤‡∏Ñ‡∏≤ ${item.price}, ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${item.description || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"}`;
                
                app.toggleLoading(true);
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ";
                    
                    Swal.fire({
                        title: '‚ú® AI Analysis',
                        html: `<div class="text-left text-gray-700 leading-relaxed">${text.replace(/\n/g, '<br>')}</div>`,
                        customClass: { popup: 'ultra-glass rounded-[32px]' },
                        confirmButtonText: '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏•‡∏¢!',
                        confirmButtonColor: '#8B5CF6'
                    });
                } catch (e) {
                    Swal.fire("AI Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "error");
                }
                app.toggleLoading(false);
            },

            fileToBase64: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            },
            
            goHome: () => {
                app.isAdmin ? app.toggleAdminView(true) : app.toggleAdminView(false);
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
